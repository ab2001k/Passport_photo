<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Passport Studio V3 - 6x6 Grid</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∏</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --panel: #ffffff;
            --border: #cbd5e1;
            /* Precise Dimensions for 1.2" x 1.4" */
            --p-width: 30.48mm;  /* 1.2 inch */
            --p-height: 35.56mm; /* 1.4 inch */
            --sheet-pad: 10mm;
            --gap: 3mm;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 350px;
            background: var(--panel);
            padding: 15px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        h2 { margin: 0; font-size: 1.2rem; padding-bottom: 8px; border-bottom: 1px solid var(--border); }

        .control-group {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .hidden { display: none; }

        label { font-size: 0.75rem; font-weight: 700; color: #475569; display: block; margin-bottom: 5px; text-transform: uppercase; }
        
        input[type="text"], input[type="file"] {
            width: 100%; padding: 8px; margin-bottom: 5px;
            border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; font-size: 0.8rem;
        }

        button {
            background: var(--primary); color: white; border: none; padding: 10px;
            border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;
            margin-bottom: 5px; transition: 0.2s; font-size: 0.85rem;
        }
        button:hover { opacity: 0.9; }
        button.secondary { background: white; color: #333; border: 1px solid var(--border); }
        button.danger { background: #ef4444; color: white; }

        /* Draggable Source */
        #sourcePreview {
            width: 120px; height: 140px;
            background: #ddd; border: 2px dashed #999;
            margin: 0 auto; cursor: grab;
            background-size: cover; background-position: center;
        }

        /* --- Workspace --- */
        .workspace {
            flex: 1;
            background: #cbd5e1;
            padding: 30px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto;
        }

        #a4-sheet {
            width: 210mm; height: 297mm;
            background: white;
            padding: var(--sheet-pad);
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            position: relative;
            box-sizing: border-box;
            
            /* CSS GRID for 6x6 Layout */
            display: grid;
            grid-template-columns: repeat(6, var(--p-width));
            grid-template-rows: repeat(6, var(--p-height));
            gap: var(--gap);
            justify-content: center;
            align-content: start;
        }

        /* The Slot */
        .slot {
            width: var(--p-width);
            height: var(--p-height);
            border: 1px dashed #e2e8f0;
            position: relative;
            background-color: #f8fafc;
            transition: 0.2s;
        }
        .slot.filled {
            border: 2px solid black; /* The requested stroke */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .slot:hover { border-color: var(--primary); }
        
        /* Drag Overlay */
        .slot.drag-over { background-color: #dbeafe; border-style: solid; border-color: var(--primary); }

        /* Delete btn on hover */
        .slot.filled::after {
            content: '√ó';
            position: absolute; top: -5px; right: -5px;
            width: 15px; height: 15px;
            background: red; color: white; border-radius: 50%;
            font-size: 10px; display: none; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .slot.filled:hover::after { display: flex; }

        /* Guidelines Overlay */
        .guides {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; opacity: 0;
            z-index: 10;
        }
        .guides.active { opacity: 1; }
        
        /* Simple cutting lines visualization */
        .guides::before {
            content: ''; position: absolute;
            top: var(--sheet-pad); bottom: var(--sheet-pad);
            left: var(--sheet-pad); right: var(--sheet-pad);
            /* This creates a grid pattern using gradients */
            background-image: 
                linear-gradient(#94a3b8 1px, transparent 1px),
                linear-gradient(90deg, #94a3b8 1px, transparent 1px);
            background-size: calc(var(--p-width) + var(--gap)) calc(var(--p-height) + var(--gap));
            background-position: -1px -1px; /* Align check */
        }

        /* --- Print Styles --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { display: block; background: white; }
            .sidebar { display: none !important; }
            .workspace { padding: 0; margin: 0; overflow: visible; height: auto; }
            #a4-sheet {
                margin: 0; box-shadow: none;
                /* Force Print Colors */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                border: none;
            }
            .slot { border: none; } /* Hide empty slots */
            .slot.filled { border: 2px solid black !important; } /* Keep photo borders */
            .guides { display: none !important; } /* Hide guides unless you want them printed? usually no */
            /* If user wants guides printed: */
            .guides.print-visible { display: block !important; opacity: 0.5; } 
        }

        /* Misc */
        .crop-box { height: 250px; background: #333; margin-bottom: 10px; }
        img { max-width: 100%; }
        .color-row { display: flex; gap: 5px; margin-top: 5px; }
        .c-btn { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc;}
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Passport Studio V3</h2>
        
        <div class="control-group">
            <label>‚öôÔ∏è API Settings (Remove.bg)</label>
            <input type="text" id="apiKey" placeholder="Paste API Key here..." onchange="saveKey()">
            <small style="font-size: 9px; color: #666;">Key is saved permanently in your browser.</small>
        </div>

        <div class="control-group">
            <label>1. Upload Photo</label>
            <input type="file" id="imgInput" accept="image/*">
        </div>

        <div id="editorPanel" class="control-group hidden">
            <label>2. Crop & Edit</label>
            <div class="crop-box">
                <img id="cropImg" src="">
            </div>
            
            <label>Background Color</label>
            <div class="color-row">
                <div class="c-btn" style="background:white" onclick="setBg('white')"></div>
                <div class="c-btn" style="background:#2563eb" onclick="setBg('#2563eb')"></div>
                <div class="c-btn" style="background:#ef4444" onclick="setBg('#ef4444')"></div>
                <input type="color" id="customColor" onchange="setBg(this.value)" style="width:30px; padding:0; height:25px;">
            </div>

            <div style="margin-top: 10px; display: flex; gap: 5px;">
                <button onclick="runRemBg()">‚ú® Remove BG (API)</button>
                <button onclick="applyCrop()" class="secondary">‚úÇÔ∏è Confirm Crop</button>
            </div>
            <div id="loading" style="display:none; color:blue; font-size:10px;">Processing...</div>
        </div>

        <div id="dragPanel" class="control-group hidden">
            <label>3. Drag to Sheet</label>
            <div id="sourcePreview" draggable="true" ondragstart="drag(event)"></div>
            <div style="text-align: center; font-size: 10px; margin: 5px 0;">
                Drag photo above to any grid slot ->
            </div>
            <button onclick="fillGrid()">Fill All Slots (36)</button>
        </div>

        <div class="control-group">
            <label>4. Print Controls</label>
            <button class="secondary" onclick="toggleGuides()">üìè Toggle Grid/Cut Lines</button>
            <button class="danger" onclick="resetGrid()">üóëÔ∏è Clear Grid</button>
            <button onclick="window.print()" style="margin-top: 10px; padding: 15px; font-size: 1rem;">üñ®Ô∏è PRINT SHEET</button>
        </div>
    </div>

    <div class="workspace">
        <div id="a4-sheet">
            <div class="guides" id="guideOverlay"></div>
            </div>
    </div>

<script>
    // --- Config ---
    // 1.2" = 30.48mm | 1.4" = 35.56mm
    // Aspect Ratio = 1.2 / 1.4 = 0.857
    const ASPECT_RATIO = 1.2 / 1.4;
    const TOTAL_SLOTS = 36; // 6x6

    // --- State ---
    let cropper = null;
    let finalImageURL = null;
    let currentBg = 'white';

    // --- Init ---
    window.onload = () => {
        // Load API Key
        const savedKey = localStorage.getItem('rembg_api_key');
        if(savedKey) document.getElementById('apiKey').value = savedKey;

        // Generate Grid
        const sheet = document.getElementById('a4-sheet');
        for(let i=0; i<TOTAL_SLOTS; i++) {
            const slot = document.createElement('div');
            slot.className = 'slot';
            slot.setAttribute('data-id', i);
            
            // Drag Events
            slot.ondragover = allowDrop;
            slot.ondrop = drop;
            slot.onclick = function() { 
                if(this.classList.contains('filled')) {
                    this.style.backgroundImage = '';
                    this.classList.remove('filled');
                } else if(finalImageURL) {
                    // Optional: Click to fill if empty and source exists
                    fillSlot(this);
                }
            };
            sheet.appendChild(slot);
        }
        
        // Move guide overlay to end
        sheet.appendChild(document.getElementById('guideOverlay'));
    };

    function saveKey() {
        const k = document.getElementById('apiKey').value;
        localStorage.setItem('rembg_api_key', k);
        alert("API Key Saved!");
    }

    // --- 1. Image Load ---
    document.getElementById('imgInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('cropImg').src = e.target.result;
            document.getElementById('editorPanel').classList.remove('hidden');
            initCropper();
        };
        reader.readAsDataURL(file);
    });

    function initCropper() {
        if(cropper) cropper.destroy();
        cropper = new Cropper(document.getElementById('cropImg'), {
            aspectRatio: ASPECT_RATIO,
            viewMode: 1
        });
    }

    // --- 2. Remove BG (API) ---
    async function runRemBg() {
        const key = document.getElementById('apiKey').value;
        if(!key) { alert("Please enter API Key in settings first."); return; }
        
        const loader = document.getElementById('loading');
        loader.style.display = 'block';

        cropper.getCroppedCanvas().toBlob(async (blob) => {
            const formData = new FormData();
            formData.append('image_file', blob);
            formData.append('size', 'auto');

            try {
                const res = await fetch('https://api.remove.bg/v1.0/removebg', {
                    method: 'POST',
                    headers: { 'X-Api-Key': key },
                    body: formData
                });
                
                if(!res.ok) throw new Error("API Error: " + res.status);
                
                const rBlob = await res.blob();
                const url = URL.createObjectURL(rBlob);
                cropper.replace(url);
            } catch(e) {
                alert("API Failed: " + e.message);
            } finally {
                loader.style.display = 'none';
            }
        });
    }

    function setBg(color) {
        currentBg = color;
    }

    // --- 3. Process Final Image ---
    function applyCrop() {
        if(!cropper) return;
        
        // High Res Canvas
        const canvas = cropper.getCroppedCanvas({
            width: 600, // Good quality for print
            imageSmoothingQuality: 'high'
        });

        // Add Background Color
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = canvas.width;
        finalCanvas.height = canvas.height;
        const ctx = finalCanvas.getContext('2d');
        
        ctx.fillStyle = currentBg;
        ctx.fillRect(0,0, finalCanvas.width, finalCanvas.height);
        ctx.drawImage(canvas, 0, 0);

        finalImageURL = finalCanvas.toDataURL('image/jpeg', 0.95);
        
        // Update Source Preview
        const preview = document.getElementById('sourcePreview');
        preview.style.backgroundImage = `url(${finalImageURL})`;
        document.getElementById('dragPanel').classList.remove('hidden');
    }

    // --- 4. Drag & Drop Logic ---
    function drag(ev) {
        ev.dataTransfer.setData("text", "source");
    }

    function allowDrop(ev) {
        ev.preventDefault();
        ev.target.classList.add('drag-over');
    }

    // Handle "dragleave" to remove highlight
    document.addEventListener('dragleave', (e) => {
        if(e.target.classList.contains('slot')) e.target.classList.remove('drag-over');
    });

    function drop(ev) {
        ev.preventDefault();
        ev.target.classList.remove('drag-over');
        // Only drop into slots
        if(ev.target.classList.contains('slot') && finalImageURL) {
            fillSlot(ev.target);
        }
    }

    function fillSlot(el) {
        el.style.backgroundImage = `url(${finalImageURL})`;
        el.classList.add('filled');
    }

    function fillGrid() {
        if(!finalImageURL) return;
        document.querySelectorAll('.slot').forEach(s => fillSlot(s));
    }

    function resetGrid() {
        document.querySelectorAll('.slot').forEach(s => {
            s.style.backgroundImage = '';
            s.classList.remove('filled');
        });
    }

    // --- 5. Guides ---
    function toggleGuides() {
        const g = document.getElementById('guideOverlay');
        g.classList.toggle('active');
        // Also add a class to make them visible in print if desired
        g.classList.toggle('print-visible');
    }

</script>
</body>
</html>
