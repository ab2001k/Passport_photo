<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Passport Studio - V2</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∏</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --panel: #ffffff;
            --text: #1e293b;
            --border: #cbd5e1;
            /* Precise A4 Dimensions */
            --a4-w: 210mm;
            --a4-h: 297mm;
            /* Passport Specs */
            --photo-w: 35mm; /* Standard width (adjustable in JS) */
            --photo-h: 45mm; /* Standard height (adjustable in JS) */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 360px;
            background: var(--panel);
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 20;
        }

        h2 { margin: 0 0 5px 0; font-size: 1.2rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        
        .control-group {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        label { font-size: 0.75rem; font-weight: 700; color: #475569; display: block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-bottom: 5px;
            transition: 0.2s;
            font-size: 0.85rem;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        button:hover { opacity: 0.9; }
        button.danger { background: #ef4444; color: white; }
        button.secondary { background: white; color: #334155; border: 1px solid var(--border); }
        button.secondary:hover { background: #f1f5f9; border-color: #94a3b8; }

        /* --- Crop Area --- */
        .crop-container {
            height: 300px;
            background: #333;
            margin-bottom: 10px;
            border-radius: 4px;
            overflow: hidden;
        }
        #imageToCrop { max-width: 100%; display: block; }

        /* --- Color Picker with Logo --- */
        .color-picker-wrapper {
            position: relative;
            width: 100%;
            height: 35px;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
        }
        input[type="color"] {
            width: 150%; height: 150%;
            position: absolute; top: -25%; left: -25%;
            cursor: pointer; border: none; padding: 0;
        }
        .picker-icon {
            position: absolute;
            right: 10px; top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            background: white;
            padding: 4px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- Workspace (The A4 Sheet) --- */
        .workspace {
            flex: 1;
            background: #cbd5e1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow: auto;
        }

        #a4-sheet {
            width: var(--a4-w);
            height: var(--a4-h);
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            /* THE NEW LAYOUT ENGINE: FLEXBOX */
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start; /* Fill from top */
            /* "Small Blanks" (Margins) */
            padding: 5mm; 
            /* "Good cuttings gaps" */
            gap: 2mm; 
            box-sizing: border-box;
            position: relative;
        }

        /* The Photo on Sheet */
        .passport-photo {
            /* Exact Dimensions */
            width: 35mm; 
            height: 45mm;
            background-size: cover;
            background-position: center;
            /* "Color border (stroke, black 2px)" */
            border: 2px solid black; 
            box-sizing: border-box; /* Includes border in width */
            position: relative;
            cursor: pointer;
        }
        
        .passport-photo:hover::after {
            content: 'Click to Delete';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,0,0,0.5);
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold;
        }

        /* --- Print Mode --- */
        @media print {
            body { background: white; display: block; }
            .sidebar { display: none; }
            .workspace { padding: 0; margin: 0; overflow: visible; }
            #a4-sheet {
                box-shadow: none; margin: 0;
                width: 210mm; height: 297mm;
                page-break-after: always;
            }
        }
        
        .loader { display: none; font-size: 0.8rem; color: var(--primary); margin: 5px 0; text-align: center;}
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Pro Passport Studio</h2>
        
        <div class="control-group">
            <label>1. Image Source</label>
            <input type="file" id="imageInput" accept="image/*" style="font-size: 0.8rem; width: 100%;">
            
            <div id="loader" class="loader">‚öôÔ∏è Processing API...</div>
            <button onclick="removeBgApi()" style="margin-top: 8px; background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                ‚ú® Magic Remove BG
            </button>
            <small style="font-size: 10px; color: #64748b;">Key: ...859e8 (Remove.bg)</small>
        </div>

        <div class="control-group">
            <label>2. Crop & Edit (Full Control)</label>
            <div class="crop-container">
                <img id="imageToCrop" src="" alt="Upload Image first">
            </div>
            <button onclick="applyCrop()" class="secondary">‚úÇÔ∏è Apply Crop</button>
        </div>

        <div class="control-group">
            <label>3. Background Color</label>
            <div class="color-picker-wrapper">
                <input type="color" id="bgColor" value="#ffffff" onchange="updatePreviewColor()">
                <div class="picker-icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>4. A4 Sheet Actions</label>
            <div style="display: flex; gap: 5px;">
                <button onclick="addPhoto()">‚ûï Add 1</button>
                <button onclick="fillPage()" class="secondary">Fill Page</button>
            </div>
            
            <div style="display: flex; gap: 5px;">
                <button onclick="removeLast()" class="danger" style="background: #fbbf24; color: black;">Undo (-1)</button>
                <button onclick="clearSheet()" class="danger">Clear All</button>
            </div>
            
            <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 10px 0;">
            
            <button onclick="window.print()" style="font-size: 1rem; padding: 12px;">üñ®Ô∏è PRINT A4</button>
            <button onclick="downloadPDF()" class="secondary">üìÑ Save as PDF</button>
        </div>
    </div>

    <div class="workspace">
        <div id="a4-sheet"></div>
    </div>

<script>
    // --- Configuration ---
    const PASSPORT_W_MM = 35; // Standard 3.5cm
    const PASSPORT_H_MM = 45; // Standard 4.5cm
    // Calculate max photos per page dynamically
    // A4 = 210x297. Padding=5mm. Width Avail=200. Height Avail=287.
    // Gap=2mm. 
    // This layout engine relies on CSS Flexbox to do the math automatically.

    // --- State ---
    let cropper = null;
    let finalImageData = null; // The processed image ready for the sheet
    const imageToCrop = document.getElementById('imageToCrop');
    
    // --- 1. Image Upload & Cropper Init ---
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            imageToCrop.src = event.target.result;
            initCropper();
        };
        reader.readAsDataURL(file);
    });

    function initCropper() {
        if(cropper) cropper.destroy();
        
        cropper = new Cropper(imageToCrop, {
            aspectRatio: PASSPORT_W_MM / PASSPORT_H_MM, // Locked Ratio
            viewMode: 1, // Restrict crop box to canvas
            autoCropArea: 0.8,
            responsive: true,
            background: false, // Hide grid behind image
        });
    }

    // --- 2. Remove BG API (Using Provided Key) ---
    async function removeBgApi() {
        if(!cropper) { alert("Please upload an image first"); return; }
        
        const loader = document.getElementById('loader');
        loader.style.display = 'block';

        // Get current cropped image from cropper as blob
        cropper.getCroppedCanvas().toBlob(async (blob) => {
            const formData = new FormData();
            formData.append('image_file', blob);
            formData.append('size', 'auto');

            try {
                // Official Remove.bg API Endpoint
                const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': 'b83352b6-adf7-4baf-b4ab-1f93760859e8' // YOUR KEY
                    },
                    body: formData
                });

                if(!response.ok) throw new Error('API Failed: ' + response.statusText);

                const resultBlob = await response.blob();
                const url = URL.createObjectURL(resultBlob);
                
                // Replace image in cropper with transparent one
                cropper.replace(url);
                loader.style.display = 'none';

            } catch (err) {
                console.error(err);
                alert("API Error: Check internet or Key quota. (Using original image)");
                loader.style.display = 'none';
            }
        });
    }

    // --- 3. Apply Crop & Generate Final Image ---
    function applyCrop() {
        if(!cropper) return;
        
        // Get canvas
        const canvas = cropper.getCroppedCanvas({
            width: 413, // ~3.5cm @ 300dpi
            height: 531, // ~4.5cm @ 300dpi
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });

        // Composite background color
        const ctx = canvas.getContext('2d');
        const bgColor = document.getElementById('bgColor').value;
        
        // Create a new canvas to flatten transparency
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = canvas.width;
        finalCanvas.height = canvas.height;
        const fCtx = finalCanvas.getContext('2d');
        
        // 1. Fill Background
        fCtx.fillStyle = bgColor;
        fCtx.fillRect(0,0, finalCanvas.width, finalCanvas.height);
        
        // 2. Draw Image
        fCtx.drawImage(canvas, 0, 0);

        finalImageData = finalCanvas.toDataURL('image/jpeg', 1.0);
        
        // Visual feedback
        const btn = document.querySelector('button[onclick="applyCrop()"]');
        const oldText = btn.innerText;
        btn.innerText = "‚úÖ Saved!";
        setTimeout(() => btn.innerText = oldText, 1000);
    }

    function updatePreviewColor() {
        if(finalImageData) applyCrop(); // Re-render if color changes
    }

    // --- 4. Sheet Management (The Grid Logic) ---
    const sheet = document.getElementById('a4-sheet');

    function createPhotoEl() {
        if(!finalImageData) { applyCrop(); if(!finalImageData) return null; }
        
        const div = document.createElement('div');
        div.className = 'passport-photo';
        div.style.backgroundImage = `url(${finalImageData})`;
        div.onclick = function() { this.remove(); }; // Click to delete individual
        return div;
    }

    function addPhoto() {
        const el = createPhotoEl();
        if(el) sheet.appendChild(el);
    }

    function removeLast() {
        if(sheet.lastChild) {
            sheet.lastChild.remove();
        }
    }

    function fillPage() {
        // Calculate how many fit
        // 35mm wide + 2mm gap + 2mm border*2 (box sizing handles border)
        // Actually, box-sizing: border-box means 35mm INCLUDES border.
        // A4 content width = 210 - 10 (padding) = 200mm
        // Item width = 35mm. Gap = 2mm.
        // Items per row = floor((200 + 2) / (35 + 2)) = floor(202/37) = 5.45 -> 5 photos/row
        // Height avail = 297 - 10 = 287mm
        // Item height = 45mm. Gap = 2mm.
        // Rows = floor((287 + 2) / (45 + 2)) = floor(289/47) = 6.1 -> 6 rows
        // Total = 30 photos
        
        const maxPhotos = 30; // Safe estimate for 35x45mm on A4
        const current = sheet.children.length;
        const needed = maxPhotos - current;
        
        for(let i=0; i<needed; i++) addPhoto();
    }

    function clearSheet() {
        sheet.innerHTML = '';
    }

    // --- 5. PDF Download ---
    function downloadPDF() {
        const element = document.getElementById('a4-sheet');
        const opt = {
            margin:       0,
            filename:     'my-passport-photos.pdf',
            image:        { type: 'jpeg', quality: 1 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>
</body>
</html>
