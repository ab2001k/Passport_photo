<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Passport Photo Maker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∏</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --panel: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 360px;
            background: var(--panel);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 4px 0 24px rgba(0,0,0,0.02);
            z-index: 20;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 5px;
        }

        h2 { margin: 0; font-size: 1.25rem; color: #0f172a; letter-spacing: -0.5px; }

        .github-btn {
            background: #24292e;
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 6px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .github-btn:hover { opacity: 0.9; }

        .control-group {
            background: #fff;
            padding: 15px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            transition: 0.2s;
        }
        .control-group:hover { border-color: #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }

        label { font-size: 0.8rem; font-weight: 600; color: #475569; display: block; margin-bottom: 6px; margin-top: 10px; }
        label:first-child { margin-top: 0; }

        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--primary); }
        select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; }

        /* Buttons */
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: 0.2s;
            width: 100%;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        button:hover { background: var(--primary-hover); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button.danger { background: white; color: var(--danger); border: 1px solid var(--danger); }
        button.danger:hover { background: #fef2f2; }
        button.secondary { background: #f1f5f9; color: #334155; border: 1px solid #cbd5e1; }
        button.secondary:hover { background: #e2e8f0; }

        /* Color Picker */
        .color-options { display: flex; gap: 8px; margin-bottom: 10px; }
        .color-btn { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #e2e8f0; cursor: pointer; transition: transform 0.1s; }
        .color-btn:hover { transform: scale(1.1); border-color: var(--primary); }
        
        /* Preview Area */
        .preview-box {
            width: 100%;
            height: 220px;
            background: repeating-conic-gradient(#f8fafc 0% 25%, transparent 0% 50%) 50% / 20px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #cbd5e1;
            border-radius: var(--radius);
            margin-bottom: 10px;
            overflow: hidden;
            position: relative;
        }
        #editorCanvas { max-height: 90%; max-width: 90%; box-shadow: var(--shadow); border: 4px solid white; }

        /* --- Workspace (A4) --- */
        .workspace {
            flex: 1;
            background: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px;
            overflow: auto;
            /* Aesthetic Grid Pattern */
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #a4-sheet {
            width: 210mm;
            height: 297mm;
            background: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }

        /* Border Overlay (Hidden by default) */
        .page-border {
            position: absolute;
            top: 5mm; left: 5mm; right: 5mm; bottom: 5mm;
            border: 1px solid #000;
            pointer-events: none;
            display: none;
            z-index: 5;
        }

        /* Grid Helper */
        .grid-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background-size: 27.9mm 38.1mm; /* Exact Photo Size Grid */
            background-image: 
                linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            opacity: 0;
            z-index: 1;
        }
        #showGrid:checked ~ .workspace #a4-sheet .grid-overlay { opacity: 1; }
        #showBorder:checked ~ .workspace #a4-sheet .page-border { display: block; }

        /* The Photo */
        .passport-photo {
            width: 27.9mm;
            height: 38.1mm;
            position: absolute;
            cursor: grab;
            user-select: none;
            box-sizing: border-box;
            border: 1px solid #e2e8f0; 
            transition: box-shadow 0.2s;
            z-index: 2;
        }
        .passport-photo:hover { border-color: var(--primary); z-index: 10; }
        .passport-photo:active { cursor: grabbing; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 20; }
        
        .passport-photo .delete-btn {
            position: absolute; top: -6px; right: -6px;
            width: 18px; height: 18px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            display: none;
            align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .passport-photo:hover .delete-btn { display: flex; }

        .loader { display: none; text-align: center; color: var(--primary); font-size: 0.85rem; margin: 10px 0; font-weight: 500;}

        /* --- Print / PDF Styles --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; display: block; height: auto; overflow: visible; }
            .sidebar, .workspace { display: none !important; }
            #a4-sheet {
                display: block !important;
                position: absolute; top: 0; left: 0;
                width: 210mm; height: 297mm;
                box-shadow: none; margin: 0;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
                transform: none !important;
            }
            .passport-photo { border: 1px solid #ddd; }
            .delete-btn, .grid-overlay { display: none !important; }
            .page-border { display: block !important; border-color: #ddd; } /* Always show border on print if desired, or toggle */
        }
    </style>
</head>
<body>

    <input type="checkbox" id="showGrid" style="display:none">
    <input type="checkbox" id="showBorder" style="display:none">

    <div class="sidebar">
        <div class="header">
            <h2>PassportPro</h2>
            <a href="https://github.com/your-repo" target="_blank" class="github-btn">
                <svg height="16" viewBox="0 0 16 16" width="16" fill="white"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                GitHub
            </a>
        </div>
        
        <div class="control-group">
            <label>1. Upload Photo</label>
            <input type="file" id="imageInput" accept="image/*" style="font-size: 0.8rem;">
            <div id="loader" class="loader">‚è≥ Removing Background (might take ~30s)...</div>
            <button onclick="processBgRemove()">‚ú® AI Auto Remove BG</button>
            <div style="text-align: right; font-size: 0.7rem; color: #64748b;">*If AI fails, original image is used</div>
        </div>

        <div class="control-group">
            <label>2. Editor</label>
            
            <label>Crop & Rotate</label>
            <div style="display: flex; gap: 5px;">
                <button class="secondary" onclick="rotateImg(-90)">‚Ü∫ -90¬∞</button>
                <button class="secondary" onclick="rotateImg(90)">‚Üª +90¬∞</button>
            </div>
            
            <label>Zoom / Scale (<span id="zoomVal">1.0x</span>)</label>
            <input type="range" min="1" max="3" step="0.1" value="1" id="zoom" oninput="updateEditor()">

            <label>Background Color</label>
            <div class="color-options">
                <div class="color-btn" style="background:white" onclick="setBg('white')"></div>
                <div class="color-btn" style="background:#3b82f6" onclick="setBg('#3b82f6')"></div>
                <div class="color-btn" style="background:#ef4444" onclick="setBg('#ef4444')"></div>
                <div class="color-btn" style="background:#cbd5e1" onclick="setBg('#cbd5e1')"></div>
                <input type="color" id="customColor" onchange="setBg(this.value)" style="height:32px; width:32px; padding:0; border:none; border-radius: 50%;">
            </div>

            <div class="preview-box">
                <canvas id="editorCanvas"></canvas>
            </div>
            
            <button class="secondary" onclick="addToSheet()">‚¨áÔ∏è Add Photo to Sheet</button>
        </div>

        <div class="control-group">
            <h3>3. Layout & Print</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button class="secondary" onclick="fillPage(8)">Grid 8</button>
                <button class="secondary" onclick="fillPage(32)">Full (32)</button>
            </div>

            <label>View Options:</label>
            <div style="display: flex; gap: 10px; font-size: 0.85rem; color: #334155;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: normal;">
                    <input type="checkbox" onchange="document.getElementById('showGrid').checked = this.checked"> Show Grid
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: normal;">
                    <input type="checkbox" onchange="document.getElementById('showBorder').checked = this.checked"> Page Border
                </label>
            </div>
            
            <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;">
                <button class="danger" onclick="clearSheet()">Clear Sheet</button>
                <button style="background: #10b981;" onclick="downloadPDF()">üìÑ Download PDF</button>
                <button onclick="window.print()">üñ®Ô∏è Print A4</button>
            </div>
        </div>
    </div>

    <div class="workspace">
        <div id="a4-sheet">
            <div class="grid-overlay"></div>
            <div class="page-border"></div>
        </div>
    </div>

<script>
    // --- Config ---
    const PHOTO_W = 330; // 2.79cm @ ~300dpi
    const PHOTO_H = 450; // 3.81cm @ ~300dpi
    const MM_TO_PX = 3.7795;
    
    // State
    let originalImage = null; // The file from disk
    let currentSubject = null; // Either original or BG-removed version
    let bgImage = null;
    let bgColor = 'white';
    
    // Editor State
    let rotationAngle = 0;
    let zoomLevel = 1.0;
    
    // Elements
    const canvas = document.getElementById('editorCanvas');
    const ctx = canvas.getContext('2d');
    const sheet = document.getElementById('a4-sheet');

    canvas.width = PHOTO_W;
    canvas.height = PHOTO_H;

    // --- 1. Load Image (Robust) ---
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                originalImage = img;
                currentSubject = img; // Default to original immediately
                // Reset edits
                rotationAngle = 0;
                zoomLevel = 1.0;
                document.getElementById('zoom').value = 1;
                updateEditor();
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    });

    // --- 2. Background Removal (Fail-Safe) ---
    async function processBgRemove() {
        const fileInput = document.getElementById('imageInput');
        if (!fileInput.files[0]) { alert("Please upload an image first."); return; }

        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        
        const formData = new FormData();
        formData.append('image', fileInput.files[0]); 

        try {
            // Your Render URL
            const apiUrl = 'https://rembg-api-1-86lg.onrender.com/remove-bg'; 
            
            // Timeout promise to catch "hanging" requests
            const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 60000));
            
            const fetchReq = fetch(apiUrl, { method: 'POST', body: formData });
            const response = await Promise.race([fetchReq, timeout]);

            if (!response.ok) throw new Error(`API Error: ${response.status}`);

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            
            const img = new Image();
            img.onload = () => {
                currentSubject = img; // Update only on success
                loader.style.display = 'none';
                updateEditor();
            }
            img.src = url;

        } catch (error) {
            console.error(error);
            loader.style.display = 'none';
            alert("‚ö†Ô∏è Background removal failed (Server busy or timeout).\n\nDon't worry! Using original image. You can still Crop, Rotate & Print.");
            // We do nothing to 'currentSubject', so it remains 'originalImage'
        }
    }

    // --- 3. Editor Logic (Rotate & Zoom) ---
    function rotateImg(deg) {
        rotationAngle = (rotationAngle + deg) % 360;
        updateEditor();
    }

    function setBg(color) {
        bgColor = color;
        updateEditor();
    }

    function updateEditor() {
        if (!currentSubject) return;

        // 1. Zoom Reading
        zoomLevel = parseFloat(document.getElementById('zoom').value);
        document.getElementById('zoomVal').innerText = zoomLevel.toFixed(1) + 'x';

        // Clear
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 2. Draw Background
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 3. Prepare Image (Rotation & Scale)
        // We use an offscreen logic concept but drawn directly
        ctx.save();
        
        // Move to center of canvas
        ctx.translate(canvas.width/2, canvas.height/2);
        
        // Rotate
        ctx.rotate(rotationAngle * Math.PI / 180);
        
        // Scale (Zoom)
        ctx.scale(zoomLevel, zoomLevel);

        // Logic to "Cover" the canvas with the image
        // We need to know if the image is rotated 90/270 to calculate aspect ratio correctly
        let imgAspect = currentSubject.width / currentSubject.height;
        let canvasAspect = canvas.width / canvas.height;
        
        // If rotated 90 or 270, the "width" of the image roughly aligns with "height" of canvas
        const isSideways = Math.abs(rotationAngle) === 90 || Math.abs(rotationAngle) === 270;
        
        let drawW, drawH;

        if (isSideways) {
             // Inverted logic for fit
             if ((currentSubject.height / currentSubject.width) > canvasAspect) {
                drawW = canvas.height * (currentSubject.width / currentSubject.height);
                drawH = canvas.height;
             } else {
                drawW = canvas.width;
                drawH = canvas.width * (currentSubject.height / currentSubject.width);
             }
             // Actually, simplest "Cover" logic regardless of rotation:
             // Draw the image centered at 0,0 such that it covers the box
             // It's tricky with rotation.
             // Fallback: Just draw image centered.
             drawW = currentSubject.width;
             drawH = currentSubject.height;
        } 
        
        // Simplified "Smart Fit"
        // We draw the image such that the smaller dimension matches the canvas
        // then apply zoom.
        const scaleFactor = Math.max(canvas.width / currentSubject.width, canvas.height / currentSubject.height);
        
        // If sideways, we might need a different scale factor? 
        // Let's keep it simple: Draw image at center offset.
        
        ctx.drawImage(
            currentSubject, 
            -currentSubject.width/2, 
            -currentSubject.height/2, 
            currentSubject.width, 
            currentSubject.height
        );

        ctx.restore();
    }

    // --- 4. Sheet Functions ---
    function addToSheet() {
        if (!currentSubject) return;
        const dataUrl = canvas.toDataURL('image/jpeg', 1.0);
        
        const div = document.createElement('div');
        div.className = 'passport-photo';
        div.style.backgroundImage = `url(${dataUrl})`;
        div.style.backgroundSize = 'cover'; // Ensure edited view fills slot
        
        // Default Position (Next available slot logic or just top-left)
        // Find first gap logic is complex, just cascading for now
        const existing = document.querySelectorAll('.passport-photo').length;
        const col = existing % 6;
        const row = Math.floor(existing / 6);
        
        div.style.left = (10 + col * (27.9 + 2)) + 'mm';
        div.style.top = (10 + row * (38.1 + 2)) + 'mm';

        // Delete Button
        const btn = document.createElement('div');
        btn.className = 'delete-btn';
        btn.innerHTML = '√ó';
        btn.onclick = (e) => { e.stopPropagation(); div.remove(); };
        div.appendChild(btn);

        makeDraggable(div);
        sheet.appendChild(div);
    }

    function fillPage(count) {
        clearSheet();
        for(let i=0; i<count; i++) addToSheet();
    }

    function clearSheet() {
        document.querySelectorAll('.passport-photo').forEach(e => e.remove());
    }

    // --- 5. Download PDF ---
    function downloadPDF() {
        const element = document.getElementById('a4-sheet');
        
        // Configure options
        const opt = {
            margin:       0,
            filename:     'passport-photos.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, scrollX: 0, scrollY: 0 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Hide guidelines/buttons for capture
        const border = document.querySelector('.page-border');
        const grid = document.querySelector('.grid-overlay');
        const wasBorder = border.style.display;
        const wasGrid = grid.style.opacity;
        
        // Temporary clean look
        border.style.display = 'none';
        grid.style.opacity = '0';
        
        html2pdf().set(opt).from(element).save().then(() => {
            // Restore state
            border.style.display = wasBorder;
            grid.style.opacity = wasGrid;
        });
    }

    // --- Drag Logic (Standard) ---
    function makeDraggable(el) {
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        el.addEventListener('mousedown', (e) => {
            if(e.target.className === 'delete-btn') return;
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = parseFloat(el.style.left || 0);
            initialTop = parseFloat(el.style.top || 0);
            el.style.zIndex = 100;
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const dxMM = (e.clientX - startX) / MM_TO_PX;
            const dyMM = (e.clientY - startY) / MM_TO_PX;
            el.style.left = (initialLeft + dxMM) + 'mm';
            el.style.top = (initialTop + dyMM) + 'mm';
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            el.style.zIndex = '';
        });
    }
</script>
</body>
</html>
